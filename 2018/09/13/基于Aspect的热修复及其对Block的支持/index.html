<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOS," />










<meta name="description" content="[TOC]   目前很多热修复方案都被苹果禁止了，但据说基于Aspect的热修复还可以用，因为最终所有的方法实现都是oc提供的NSInvocation,本文分析了LYFix源码，并结合bang的JSPatch中的JPBlockWrapper实现了对Block的支持。   Aspect 的实现我们在LYFix提供的demo工程中可以发现，它引用了一个第三方库Aspect。在Aspect的头文件中，我">
<meta name="keywords" content="iOS">
<meta property="og:type" content="article">
<meta property="og:title" content="基于Aspect的热修复及其对Block的支持">
<meta property="og:url" content="http://yoursite.com/2018/09/13/基于Aspect的热修复及其对Block的支持/index.html">
<meta property="og:site_name" content="簡無叔_MADAO">
<meta property="og:description" content="[TOC]   目前很多热修复方案都被苹果禁止了，但据说基于Aspect的热修复还可以用，因为最终所有的方法实现都是oc提供的NSInvocation,本文分析了LYFix源码，并结合bang的JSPatch中的JPBlockWrapper实现了对Block的支持。   Aspect 的实现我们在LYFix提供的demo工程中可以发现，它引用了一个第三方库Aspect。在Aspect的头文件中，我">
<meta property="og:locale" content="default">
<meta property="og:image" content="http://yoursite.com/2018/09/13/images/avatar.png">
<meta property="og:updated_time" content="2018-09-13T13:03:52.913Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="基于Aspect的热修复及其对Block的支持">
<meta name="twitter:description" content="[TOC]   目前很多热修复方案都被苹果禁止了，但据说基于Aspect的热修复还可以用，因为最终所有的方法实现都是oc提供的NSInvocation,本文分析了LYFix源码，并结合bang的JSPatch中的JPBlockWrapper实现了对Block的支持。   Aspect 的实现我们在LYFix提供的demo工程中可以发现，它引用了一个第三方库Aspect。在Aspect的头文件中，我">
<meta name="twitter:image" content="http://yoursite.com/2018/09/13/images/avatar.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2018/09/13/基于Aspect的热修复及其对Block的支持/"/>





  <title>基于Aspect的热修复及其对Block的支持 | 簡無叔_MADAO</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/Kennaki"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png" alt="Fork me on GitHub"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">簡無叔_MADAO</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/13/基于Aspect的热修复及其对Block的支持/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kennaki Kai">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="簡無叔_MADAO">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">基于Aspect的热修复及其对Block的支持</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-09-13T11:10:07+08:00">
                2018-09-13
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>[TOC]</p>
<blockquote>
</blockquote>
<p>目前很多热修复方案都被苹果禁止了，但据说基于Aspect的热修复还可以用，因为最终所有的方法实现都是oc提供的<code>NSInvocation</code>,本文分析了<a href="http://www.cocoachina.com/ios/20180817/24600.html" target="_blank" rel="noopener">LYFix</a>源码，并结合<a href="http://blog.cnbang.net/works/2767/" target="_blank" rel="noopener">bang</a>的<a href="https://github.com/bang590/JSPatch" target="_blank" rel="noopener">JSPatch</a>中的<code>JPBlockWrapper</code>实现了对Block的支持。</p>
<blockquote>
</blockquote>
<h2 id="Aspect-的实现"><a href="#Aspect-的实现" class="headerlink" title="Aspect 的实现"></a>Aspect 的实现</h2><p>我们在<a href="http://www.cocoachina.com/ios/20180817/24600.html" target="_blank" rel="noopener">LYFix</a>提供的<a href="https://github.com/GitHubXuLiying/LYFix" target="_blank" rel="noopener">demo</a>工程中可以发现，它引用了一个第三方库Aspect。在Aspect的头文件中，我们可以看到两个核心方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// Adds a block of code before/instead/after the current `selector` for a specific class.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @param block Aspects replicates the type signature of the method being hooked.</span></span><br><span class="line"><span class="comment">/// The first parameter will be `id&lt;AspectInfo&gt;`, followed by all parameters of the method.</span></span><br><span class="line"><span class="comment">/// These parameters are optional and will be filled to match the block signature.</span></span><br><span class="line"><span class="comment">/// You can even use an empty block, or one that simple gets `id&lt;AspectInfo&gt;`.</span></span><br><span class="line"><span class="comment">///</span></span><br><span class="line"><span class="comment">/// @note Hooking static methods is not supported.</span></span><br><span class="line"><span class="comment">/// @return A token which allows to later deregister the aspect.</span></span><br><span class="line">+ (<span class="keyword">id</span>&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector</span><br><span class="line">                      withOptions:(AspectOptions)options</span><br><span class="line">                       usingBlock:(<span class="keyword">id</span>)block</span><br><span class="line">                            error:(<span class="built_in">NSError</span> **)error;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// Adds a block of code before/instead/after the current `selector` for a specific instance.</span></span><br><span class="line">- (<span class="keyword">id</span>&lt;AspectToken&gt;)aspect_hookSelector:(SEL)selector</span><br><span class="line">                      withOptions:(AspectOptions)options</span><br><span class="line">                       usingBlock:(<span class="keyword">id</span>)block</span><br><span class="line">                            error:(<span class="built_in">NSError</span> **)error;</span><br></pre></td></tr></table></figure>
<p>注释写的很清楚，这里就不做解释了，直接看核心实现：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> aspect_add(<span class="keyword">id</span> <span class="keyword">self</span>, SEL selector, AspectOptions options, <span class="keyword">id</span> block, <span class="built_in">NSError</span> **error) &#123;</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(<span class="keyword">self</span>);</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(selector);</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(block);</span><br><span class="line"></span><br><span class="line">    __block AspectIdentifier *identifier = <span class="literal">nil</span>;</span><br><span class="line">    aspect_performLocked(^&#123;<span class="comment">//1</span></span><br><span class="line">        <span class="keyword">if</span> (aspect_isSelectorAllowedAndTrack(<span class="keyword">self</span>, selector, options, error)<span class="comment">/*2*/</span>) &#123;</span><br><span class="line">            AspectsContainer *aspectContainer = aspect_getContainerForObject(<span class="keyword">self</span>, selector);<span class="comment">//3</span></span><br><span class="line">            identifier = [AspectIdentifier identifierWithSelector:selector object:<span class="keyword">self</span> options:options block:block error:error];<span class="comment">//4</span></span><br><span class="line">            <span class="keyword">if</span> (identifier) &#123;</span><br><span class="line">                [aspectContainer addAspect:identifier withOptions:options];<span class="comment">//5</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">// Modify the class to allow message interception.</span></span><br><span class="line">                aspect_prepareClassAndHookSelector(<span class="keyword">self</span>, selector, error);<span class="comment">//6</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> identifier;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心实现代码不多，就是一个c函数，第一参数如果是类方法调用，传<code>(id)self</code>,因为这个时候<code>self</code>是不存在的，所以转为元类对象。如果是实例调用，直接传<code>self</code>。以下是对上述代码中标注数字的代码行的解释。</p>
<p>###1.对代码块加锁<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> aspect_performLocked(dispatch_block_t block) &#123;</span><br><span class="line">    <span class="keyword">static</span> OSSpinLock aspect_lock = OS_SPINLOCK_INIT;</span><br><span class="line">    OSSpinLockLock(&amp;aspect_lock);</span><br><span class="line">    block();</span><br><span class="line">    OSSpinLockUnlock(&amp;aspect_lock);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>预编译的时候会发现警告，<code>OSSpinLock</code>已经在iOS10的时候deprecated了，建议使用<code>os_unfair_lock()</code>相关API。<br>这里暂时先不替换。</p>
</blockquote>
<p>###2.是否支持对此方法的hood<br><code>static BOOL aspect_isSelectorAllowedAndTrack(NSObject *self, SEL selector, AspectOptions options, NSError **error)</code>这个方法很长，就不在这里帖了，感兴趣的自己看，里面就做了这几件事情：</p>
<ul>
<li>1.生成一个set，里面包含了不可以被hood的方法，目前有<code>retain</code>,<code>release</code>,<code>autorelease</code>,<code>forwardInvocation:</code>,假如是这几个里面的一个，返回<code>NO</code>。</li>
<li>2.假如要hook的方法是<code>dealloc</code>,则需要判断<code>AspectOptions</code>，dealloc方法只支持<code>AspectPositionBefore</code>。否则要么影响对象释放，要么就会因野指针而crash。</li>
<li>3.判断是否已经被hook过了，如果已经被hook过了，则不执行下面的代码。</li>
<li>4.一切顺利，把即将要hook的方法标记为已hook。</li>
</ul>
<p>###3.生成切面容器<br>代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Loads or creates the aspect container.</span></span><br><span class="line"><span class="keyword">static</span> AspectsContainer *aspect_getContainerForObject(<span class="built_in">NSObject</span> *<span class="keyword">self</span>, SEL selector) &#123;</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(<span class="keyword">self</span>);</span><br><span class="line">    SEL aliasSelector = aspect_aliasForSelector(selector);</span><br><span class="line">    AspectsContainer *aspectContainer = objc_getAssociatedObject(<span class="keyword">self</span>, aliasSelector);</span><br><span class="line">    <span class="keyword">if</span> (!aspectContainer) &#123;</span><br><span class="line">        aspectContainer = [AspectsContainer new];</span><br><span class="line">        objc_setAssociatedObject(<span class="keyword">self</span>, aliasSelector, aspectContainer, OBJC_ASSOCIATION_RETAIN);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> aspectContainer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>static SEL aspect_aliasForSelector(SEL selector)</code>这个方法做的事情很简单，就是给即将hook的方法取个别名。接下来就是生成切面容器。</p>
<p>###4.生成<code>AspectIdentifier</code>对象<br>这个对象里有如下几个成员变量：</p>
<blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt;@property (nonatomic, assign) SEL selector;</span><br><span class="line">&gt;@property (nonatomic, strong) id block;</span><br><span class="line">&gt;@property (nonatomic, strong) NSMethodSignature *blockSignature;</span><br><span class="line">&gt;@property (nonatomic, weak) id object;</span><br><span class="line">&gt;@property (nonatomic, assign) AspectOptions options;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<p>上述成员变量都会在接下来的hook中用到。</p>
<p>###5.将<code>AspectIdentifier</code>添加到切面容器中<br>代码如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addAspect:(AspectIdentifier *)aspect withOptions:(AspectOptions)options &#123;</span><br><span class="line">    <span class="built_in">NSParameterAssert</span>(aspect);</span><br><span class="line">    <span class="built_in">NSUInteger</span> position = options&amp;AspectPositionFilter;</span><br><span class="line">    <span class="keyword">switch</span> (position) &#123;</span><br><span class="line">        <span class="keyword">case</span> AspectPositionBefore:  <span class="keyword">self</span>.beforeAspects  = [(<span class="keyword">self</span>.beforeAspects ?:@[]) arrayByAddingObject:aspect]; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AspectPositionInstead: <span class="keyword">self</span>.insteadAspects = [(<span class="keyword">self</span>.insteadAspects?:@[]) arrayByAddingObject:aspect]; <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> AspectPositionAfter:   <span class="keyword">self</span>.afterAspects   = [(<span class="keyword">self</span>.afterAspects  ?:@[]) arrayByAddingObject:aspect]; <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没啥好说的</p>
<p>###6.开始hook<br>这一步才是核心</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> aspect_prepareClassAndHookSelector(<span class="built_in">NSObject</span> *<span class="keyword">self</span>, SEL selector, <span class="built_in">NSError</span> **error) &#123;</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(selector);</span><br><span class="line">    Class klass = aspect_hookClass(<span class="keyword">self</span>, error);</span><br><span class="line">    Method targetMethod = class_getInstanceMethod(klass, selector);</span><br><span class="line">    IMP targetMethodIMP = method_getImplementation(targetMethod);</span><br><span class="line">    <span class="keyword">if</span> (!aspect_isMsgForwardIMP(targetMethodIMP)) &#123;</span><br><span class="line">        <span class="comment">// Make a method alias for the existing method implementation, it not already copied.</span></span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *typeEncoding = method_getTypeEncoding(targetMethod);</span><br><span class="line">        SEL aliasSelector = aspect_aliasForSelector(selector);</span><br><span class="line">        <span class="keyword">if</span> (![klass instancesRespondToSelector:aliasSelector]) &#123;</span><br><span class="line">            __unused <span class="built_in">BOOL</span> addedAlias = class_addMethod(klass, aliasSelector, method_getImplementation(targetMethod), typeEncoding);</span><br><span class="line">            <span class="built_in">NSCAssert</span>(addedAlias, <span class="string">@"Original implementation for %@ is already copied to %@ on %@"</span>, <span class="built_in">NSStringFromSelector</span>(selector), <span class="built_in">NSStringFromSelector</span>(aliasSelector), klass);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We use forwardInvocation to hook in.</span></span><br><span class="line">        class_replaceMethod(klass, selector, aspect_getMsgForwardIMP(<span class="keyword">self</span>, selector), typeEncoding);</span><br><span class="line">        AspectLog(<span class="string">@"Aspects: Installed hook for -[%@ %@]."</span>, klass, <span class="built_in">NSStringFromSelector</span>(selector));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中第一步就是获取要hook的类</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Class aspect_hookClass(<span class="built_in">NSObject</span> *<span class="keyword">self</span>, <span class="built_in">NSError</span> **error) &#123;</span><br><span class="line">    <span class="built_in">NSCParameterAssert</span>(<span class="keyword">self</span>);</span><br><span class="line">	Class statedClass = <span class="keyword">self</span>.class;</span><br><span class="line">	Class baseClass = object_getClass(<span class="keyword">self</span>);</span><br><span class="line">	<span class="built_in">NSString</span> *className = <span class="built_in">NSStringFromClass</span>(baseClass);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Already subclassed 【why】</span></span><br><span class="line">	<span class="keyword">if</span> ([className hasSuffix:AspectsSubclassSuffix]) &#123;</span><br><span class="line">		<span class="keyword">return</span> baseClass;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// We swizzle a class object, not a single object.</span></span><br><span class="line">	&#125;<span class="keyword">else</span> <span class="keyword">if</span> (class_isMetaClass(baseClass)) &#123;</span><br><span class="line">        <span class="keyword">return</span> aspect_swizzleClassInPlace((Class)<span class="keyword">self</span>);</span><br><span class="line">        <span class="comment">// Probably a KVO'ed class. Swizzle in place. Also swizzle meta classes in place.</span></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (statedClass != baseClass) &#123;</span><br><span class="line">        <span class="keyword">return</span> aspect_swizzleClassInPlace(baseClass);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Default case. Create dynamic subclass. 【why】</span></span><br><span class="line">	<span class="keyword">const</span> <span class="keyword">char</span> *subclassName = [className stringByAppendingString:AspectsSubclassSuffix].UTF8String;</span><br><span class="line">	Class subclass = objc_getClass(subclassName);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (subclass == <span class="literal">nil</span>) &#123;</span><br><span class="line">		subclass = objc_allocateClassPair(baseClass, subclassName, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (subclass == <span class="literal">nil</span>) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *errrorDesc = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"objc_allocateClassPair failed to allocate class %s."</span>, subclassName];</span><br><span class="line">            AspectError(AspectErrorFailedToAllocateClassPair, errrorDesc);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">		aspect_swizzleForwardInvocation(subclass);</span><br><span class="line">		aspect_hookedGetClass(subclass, statedClass);</span><br><span class="line">		aspect_hookedGetClass(object_getClass(subclass), statedClass);</span><br><span class="line">		objc_registerClassPair(subclass);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	object_setClass(<span class="keyword">self</span>, subclass);</span><br><span class="line">	<span class="keyword">return</span> subclass;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么要这么做？我们发现真正要执行hook的类其实是目标类的一个动态子类，见上述代码中的<code>why</code>注释。<br>最后通过<code>runtime</code>提供的如下方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class_replaceMethod(Class _Nullable cls, SEL _Nonnull name, IMP _Nonnull imp, </span><br><span class="line">                    <span class="keyword">const</span> <span class="keyword">char</span> * _Nullable types) </span><br><span class="line">    OBJC_AVAILABLE(<span class="number">10.5</span>, <span class="number">2.0</span>, <span class="number">9.0</span>, <span class="number">1.0</span>, <span class="number">2.0</span>);</span><br></pre></td></tr></table></figure>
<p>最终实现方法hook，自此Aspect的核心功能就介绍完毕了。接下来，LYFix还对<code>NSInvocation</code>类进行了扩展，方便我们操作js文件传到OC的指令。</p>
<hr>
<p>##对<code>NSInvocation</code>的扩展</p>
<p>头文件中，定义了两个扩展方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setMyArgument:(<span class="keyword">id</span>)obj atIndex:(<span class="built_in">NSInteger</span>)argumentIndex;</span><br><span class="line">- (<span class="keyword">id</span>)myArgumentAtIndex:(<span class="built_in">NSUInteger</span>)index;</span><br></pre></td></tr></table></figure>
<p>第二个方法没必要看，第一个方法最终调用的核心方法是<code>- (void)setMyArgument:(id)obj atIndex:(NSInteger)argumentIndex</code>，所以只看这个方法：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setMyArgument:(<span class="keyword">id</span>)obj atIndex:(<span class="built_in">NSInteger</span>)argumentIndex &#123;</span><br><span class="line"><span class="comment">//    objc_setAssociatedObject(self, &amp;argumentIndex, obj, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span></span><br><span class="line"><span class="meta">#define set_with_args_index(_index_, _type_, _sel_) \</span></span><br><span class="line"><span class="keyword">do</span> &#123; \</span><br><span class="line">_type_ arg; \</span><br><span class="line">arg = [obj _sel_]; \</span><br><span class="line">[<span class="keyword">self</span> setArgument:&amp;arg atIndex:_index_]; \</span><br><span class="line">&#125; <span class="keyword">while</span>(<span class="number">0</span>)</span><br><span class="line">    </span><br><span class="line"><span class="meta">#define set_with_args_struct(_dic_, _struct_, _param_, _key_, _sel_) \</span></span><br><span class="line"><span class="keyword">do</span> &#123; \</span><br><span class="line"><span class="keyword">if</span> (_dic_ &amp;&amp; [_dic_ isKindOfClass:[<span class="built_in">NSDictionary</span> <span class="keyword">class</span>]]) &#123; \</span><br><span class="line"><span class="keyword">if</span> ([_dic_.allKeys containsObject:_key_]) &#123; \</span><br><span class="line">_struct_._param_ = [_dic_[_key_] _sel_]; \</span><br><span class="line">&#125; \</span><br><span class="line">&#125; \</span><br><span class="line">&#125; <span class="keyword">while</span>(<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *sig = <span class="keyword">self</span>.methodSignature;</span><br><span class="line">    <span class="built_in">NSUInteger</span> count = [sig numberOfArguments];</span><br><span class="line">    <span class="built_in">NSInteger</span> index = argumentIndex + <span class="number">2</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (index &gt;= count) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">char</span> *type = (<span class="keyword">char</span> *)[sig getArgumentTypeAtIndex:index];</span><br><span class="line">    <span class="keyword">while</span> (*type == <span class="string">'r'</span> ||  <span class="comment">// const</span></span><br><span class="line">           *type == <span class="string">'n'</span> ||  <span class="comment">// in</span></span><br><span class="line">           *type == <span class="string">'N'</span> ||  <span class="comment">// inout</span></span><br><span class="line">           *type == <span class="string">'o'</span> ||  <span class="comment">// out</span></span><br><span class="line">           *type == <span class="string">'O'</span> ||  <span class="comment">// bycopy</span></span><br><span class="line">           *type == <span class="string">'R'</span> ||  <span class="comment">// byref</span></span><br><span class="line">           *type == <span class="string">'V'</span>) &#123;  <span class="comment">// oneway</span></span><br><span class="line">        type++;             <span class="comment">// cutoff useless prefix</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">BOOL</span> unsupportedType = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">switch</span> (*type) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'v'</span>:   <span class="comment">// 1:void</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'B'</span>:   <span class="comment">// 1:bool</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'c'</span>:   <span class="comment">// 1: char / BOOL</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'C'</span>:   <span class="comment">// 1: unsigned char</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'s'</span>:   <span class="comment">// 2: short</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'S'</span>:   <span class="comment">// 2: unsigned short</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'i'</span>:   <span class="comment">// 4: int / NSInteger(32bit)</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'I'</span>:   <span class="comment">// 4: unsigned int / NSUInteger(32bit)</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'l'</span>:   <span class="comment">// 4: long(32bit)</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'L'</span>:   <span class="comment">// 4: unsigned long(32bit)</span></span><br><span class="line">        &#123; <span class="comment">// 'char' and 'short' will be promoted to 'int'</span></span><br><span class="line">            set_with_args_index(index, <span class="keyword">int</span>, intValue);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'q'</span>:   <span class="comment">// 8: long long / long(64bit) / NSInteger(64bit)</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'Q'</span>:   <span class="comment">// 8: unsigned long long / unsigned long(64bit) / NSUInteger(64bit)</span></span><br><span class="line">        &#123;</span><br><span class="line">            set_with_args_index(index, <span class="keyword">long</span> <span class="keyword">long</span>, longLongValue);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'f'</span>: <span class="comment">// 4: float / CGFloat(32bit)</span></span><br><span class="line">        &#123;</span><br><span class="line">            set_with_args_index(index, <span class="keyword">float</span>, floatValue);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'d'</span>: <span class="comment">// 8: double / CGFloat(64bit)</span></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'D'</span>: <span class="comment">// 16: long double</span></span><br><span class="line">        &#123;</span><br><span class="line">            set_with_args_index(index, <span class="keyword">double</span>, doubleValue);</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'*'</span>: <span class="comment">// char *</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *arg = obj;</span><br><span class="line">            <span class="keyword">if</span> ([arg isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                <span class="keyword">const</span> <span class="keyword">void</span> *c = [arg UTF8String];</span><br><span class="line">                [<span class="keyword">self</span> setArgument:&amp;c atIndex:index];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'#'</span>: <span class="comment">// Class</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *arg = obj;</span><br><span class="line">            <span class="keyword">if</span> ([arg isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123;</span><br><span class="line">                Class klass = <span class="built_in">NSClassFromString</span>(arg);</span><br><span class="line">                <span class="keyword">if</span> (klass) &#123;</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;klass atIndex:index];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'@'</span>: <span class="comment">// id</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">id</span> arg = obj;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> ([arg isKindOfClass:JPBlockWrapper.class]) &#123;</span><br><span class="line">                __autoreleasing <span class="keyword">id</span> cb = [arg blockPtr];</span><br><span class="line">                [<span class="keyword">self</span> setArgument:&amp;cb atIndex:index];</span><br><span class="line">                Block_release((__bridge <span class="keyword">void</span> *)cb);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                [<span class="keyword">self</span> setArgument:&amp;arg atIndex:index];</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'&#123;'</span>: <span class="comment">// struct</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (strcmp(type, <span class="keyword">@encode</span>(<span class="built_in">CGPoint</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([obj isKindOfClass:<span class="built_in">NSString</span>.class]) &#123;</span><br><span class="line">                    <span class="built_in">CGPoint</span> point = <span class="built_in">CGPointFromString</span>(obj);</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;point atIndex:index];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">CGPoint</span> point = [obj <span class="built_in">CGPointValue</span>];</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;point atIndex:index];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(type, <span class="keyword">@encode</span>(<span class="built_in">CGSize</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([obj isKindOfClass:<span class="built_in">NSString</span>.class]) &#123;</span><br><span class="line">                    <span class="built_in">CGSize</span> size = <span class="built_in">CGSizeFromString</span>(obj);</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;size atIndex:index];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">CGSize</span> size = [obj <span class="built_in">CGSizeValue</span>];</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;size atIndex:index];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(type, <span class="keyword">@encode</span>(<span class="built_in">CGRect</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([obj isKindOfClass:<span class="built_in">NSString</span>.class]) &#123;</span><br><span class="line">                    <span class="built_in">CGRect</span> rect = <span class="built_in">CGRectFromString</span>(obj);</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;rect atIndex:index];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">CGRect</span> rect;</span><br><span class="line">                    rect = [obj <span class="built_in">CGRectValue</span>];</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;rect atIndex:index];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(type, <span class="keyword">@encode</span>(<span class="built_in">CGVector</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">CGVector</span> vector = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                </span><br><span class="line">              </span><br><span class="line">                <span class="built_in">NSDictionary</span> *dict = obj;</span><br><span class="line">                set_with_args_struct(dict, vector, dx, <span class="string">@"dx"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, vector, dy, <span class="string">@"dy"</span>, doubleValue);</span><br><span class="line">                [<span class="keyword">self</span> setArgument:&amp;vector atIndex:index];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(type, <span class="keyword">@encode</span>(<span class="built_in">CGAffineTransform</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">CGAffineTransform</span> form = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">NSDictionary</span> *dict = obj;</span><br><span class="line">                set_with_args_struct(dict, form, a, <span class="string">@"a"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form, b, <span class="string">@"b"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form, c, <span class="string">@"c"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form, d, <span class="string">@"d"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form, tx, <span class="string">@"tx"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form, ty, <span class="string">@"ty"</span>, doubleValue);</span><br><span class="line">                [<span class="keyword">self</span> setArgument:&amp;form atIndex:index];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(type, <span class="keyword">@encode</span>(<span class="built_in">CATransform3D</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">CATransform3D</span> form3D = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                </span><br><span class="line">                <span class="built_in">NSDictionary</span> *dict = obj;</span><br><span class="line">                set_with_args_struct(dict, form3D, m11, <span class="string">@"m11"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m12, <span class="string">@"m12"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m13, <span class="string">@"m13"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m14, <span class="string">@"m14"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m21, <span class="string">@"m21"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m22, <span class="string">@"m22"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m23, <span class="string">@"m23"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m24, <span class="string">@"m24"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m31, <span class="string">@"m31"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m32, <span class="string">@"m32"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m33, <span class="string">@"m33"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m34, <span class="string">@"m34"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m41, <span class="string">@"m41"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m42, <span class="string">@"m42"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m43, <span class="string">@"m43"</span>, doubleValue);</span><br><span class="line">                set_with_args_struct(dict, form3D, m44, <span class="string">@"m44"</span>, doubleValue);</span><br><span class="line">                [<span class="keyword">self</span> setArgument:&amp;form3D atIndex:index];</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(type, <span class="keyword">@encode</span>(<span class="built_in">NSRange</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([obj isKindOfClass:<span class="built_in">NSString</span>.class]) &#123;</span><br><span class="line">                    <span class="built_in">NSRange</span> range = <span class="built_in">NSRangeFromString</span>(obj);</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;range atIndex:index];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">NSRange</span> range = [obj rangeValue];</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;range atIndex:index];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(type, <span class="keyword">@encode</span>(<span class="built_in">UIOffset</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([obj isKindOfClass:<span class="built_in">NSString</span>.class]) &#123;</span><br><span class="line">                    <span class="built_in">UIOffset</span> offset = <span class="built_in">UIOffsetFromString</span>(obj);</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;offset atIndex:index];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">UIOffset</span> offset = [obj <span class="built_in">UIOffsetValue</span>];</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;offset atIndex:index];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (strcmp(type, <span class="keyword">@encode</span>(<span class="built_in">UIEdgeInsets</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> ([obj isKindOfClass:<span class="built_in">NSString</span>.class]) &#123;</span><br><span class="line">                    <span class="built_in">UIEdgeInsets</span> insets = <span class="built_in">UIEdgeInsetsFromString</span>(obj);</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;insets atIndex:index];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">UIEdgeInsets</span> insets = [obj <span class="built_in">UIEdgeInsetsValue</span>];</span><br><span class="line">                    [<span class="keyword">self</span> setArgument:&amp;insets atIndex:index];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                unsupportedType = <span class="literal">YES</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'^'</span>: <span class="comment">// pointer</span></span><br><span class="line">        &#123;</span><br><span class="line">            unsupportedType = <span class="literal">YES</span>;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">':'</span>: <span class="comment">// SEL</span></span><br><span class="line">        &#123;</span><br><span class="line">            unsupportedType = <span class="literal">YES</span>;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'('</span>: <span class="comment">// union</span></span><br><span class="line">        &#123;</span><br><span class="line">            unsupportedType = <span class="literal">YES</span>;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'['</span>: <span class="comment">// array</span></span><br><span class="line">        &#123;</span><br><span class="line">            unsupportedType = <span class="literal">YES</span>;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">            </span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">// what?!</span></span><br><span class="line">        &#123;</span><br><span class="line">            unsupportedType = <span class="literal">YES</span>;</span><br><span class="line">        &#125; <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    [<span class="keyword">self</span> retainArguments];</span><br><span class="line">    <span class="built_in">NSAssert</span>(!unsupportedType, <span class="string">@"arg unsupportedType"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由上面的方法可以看到，目前支持的类型有基本类型，对象类型，结构体类型，比如<strong>CGRect</strong>、<strong>CGSize</strong>等</p>
<hr>
<p>##开始热修复<br>接下来就可以通过<code>JSContext</code>提供的工具方法来与js做交互了，以LYFix提供的Demo为例，这个类提供了一系列静态方法来加载js，并与js做交互，首先这个类提供了一个获取<code>JSContext</code>单例的方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+ (JSContext *)context &#123;</span><br><span class="line">    <span class="keyword">static</span> JSContext *context;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        context = [[JSContext alloc] init];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> context;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后在启动热修复功能的方法中注册了与js通讯的一系列协议</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">JSContext *context = [<span class="keyword">self</span> context];</span><br><span class="line">context[<span class="string">@"fixMethod"</span>] = ^(<span class="built_in">NSString</span> *className, <span class="built_in">NSString</span> *selectorName, AspectOptions options, JSValue *fixImp) &#123;</span><br><span class="line">    [<span class="keyword">self</span> fixWithClassName:className opthios:options selector:selectorName fixImp:fixImp];</span><br><span class="line">&#125;;</span><br><span class="line">context[<span class="string">@"runMethod"</span>] = ^<span class="keyword">id</span>(<span class="built_in">NSString</span> * className, <span class="built_in">NSString</span> *selectorName, <span class="keyword">id</span> arguments) &#123;</span><br><span class="line">    <span class="keyword">id</span> obj = [<span class="keyword">self</span> runWithClassname:className selector:selectorName arguments:arguments];</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">context[<span class="string">@"runInstanceMethod"</span>] = ^<span class="keyword">id</span>(<span class="keyword">id</span> instance, <span class="built_in">NSString</span> *selectorName, <span class="keyword">id</span> arguments) &#123;</span><br><span class="line">    <span class="keyword">id</span> obj = [<span class="keyword">self</span> runWithInstance:instance selector:selectorName arguments:arguments];</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">context[<span class="string">@"runClassMethod"</span>] = ^<span class="keyword">id</span>(<span class="built_in">NSString</span> * className, <span class="built_in">NSString</span> *selectorName, <span class="keyword">id</span> arguments) &#123;</span><br><span class="line">    <span class="keyword">id</span> obj = [<span class="keyword">self</span> runWithClassname:className selector:selectorName arguments:arguments];</span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">context[<span class="string">@"runInvocation"</span>] = ^(<span class="built_in">NSInvocation</span> *invocation) &#123;</span><br><span class="line">    [invocation invoke];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">context[<span class="string">@"setInvocationArguments"</span>] = ^(<span class="built_in">NSInvocation</span> *invocation, <span class="keyword">id</span> arguments) &#123;</span><br><span class="line">    <span class="keyword">if</span> ([arguments isKindOfClass:<span class="built_in">NSArray</span>.class]) &#123;</span><br><span class="line">        invocation.arguments = arguments;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [invocation setMyArgument:arguments atIndex:<span class="number">0</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">context[<span class="string">@"setInvocationArgumentAtIndex"</span>] = ^(<span class="built_in">NSInvocation</span> *invocation, <span class="keyword">id</span> argument,<span class="built_in">NSInteger</span> index) &#123;</span><br><span class="line">    [invocation setMyArgument:argument atIndex:index];</span><br><span class="line">&#125;;</span><br><span class="line">context[<span class="string">@"setInvocationReturnValue"</span>] = ^(<span class="built_in">NSInvocation</span> *invocation, <span class="keyword">id</span> returnValue) &#123;</span><br><span class="line">    invocation.returnValue_obj = returnValue;</span><br><span class="line">&#125;;</span><br><span class="line">context[<span class="string">@"runError"</span>] = ^(<span class="built_in">NSString</span> *instanceName, <span class="built_in">NSString</span> *selectorName) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"runError: instanceName = %@, selectorName = %@"</span>, instanceName, selectorName);</span><br><span class="line">&#125;;</span><br><span class="line">context[<span class="string">@"runLog"</span>] = ^(<span class="keyword">id</span> logs) &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"xly--%@"</span>,logs);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>demo中列出了上述方法，基本上可以实现所有的Native方法的调用，如果自己觉得不够，还可以自己添加，比如在支持Block的时候我就添加了一个协议，这个在下一章再讲。上面的几个通讯协议中，用到了两个核心的方法</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">id</span>)runWithClassname:(<span class="built_in">NSString</span> *)className selector:(<span class="built_in">NSString</span> *)selector arguments:(<span class="built_in">NSArray</span> *)arguments;</span><br><span class="line">+ (<span class="keyword">id</span>)runWithInstance:(<span class="keyword">id</span>)instance selector:(<span class="built_in">NSString</span> *)selector arguments:(<span class="built_in">NSArray</span> *)arguments;</span><br></pre></td></tr></table></figure>
<p>这两个方法实现都很简单，感兴趣的自己看demo。这两个方法都用到了上一章中invocation扩展所提供的setArguments方法。最后加载js文件：<code>[[self context] evaluateScript:jsString];</code>。<br>这样就是实现了把js文件中所调用的Native的方法hook到目标对象或者类的特定方法中。</p>
<hr>
<p>##使用案例</p>
<p>###编写js热补丁文件<br>Demo中提供了一个比较全面的使用案例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> self;</span><br><span class="line">fixMethod(<span class="string">'ViewController'</span>,<span class="string">'viewDidLoad'</span>,<span class="number">1</span>,<span class="function"><span class="keyword">function</span>(<span class="params">instance,invocation,arg</span>)</span>&#123;</span><br><span class="line">          runError(instance, <span class="string">'viewaaa'</span>);</span><br><span class="line">          <span class="keyword">var</span> co = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="built_in">Math</span>.random(),<span class="built_in">Math</span>.random(),<span class="built_in">Math</span>.random(),<span class="built_in">Math</span>.random());</span><br><span class="line">          <span class="keyword">var</span> color = runMethod(<span class="string">'UIColor'</span>,<span class="string">'colorWithRed:green:blue:alpha:'</span>,co);</span><br><span class="line">          <span class="keyword">var</span> view = runInstanceMethod(instance,<span class="string">'view'</span>);</span><br><span class="line">          self = instance;</span><br><span class="line">          <span class="keyword">var</span> view = runInstanceMethod(self,<span class="string">'view'</span>);</span><br><span class="line">          runInstanceMethod(view,<span class="string">'setBackgroundColor:'</span>,<span class="keyword">new</span> <span class="built_in">Array</span>(color));</span><br><span class="line">          <span class="keyword">var</span> dataSource = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="string">'instanceMethodCrash'</span>,<span class="string">'calssMethodCrash'</span>,<span class="string">'runBeforeClassMethod'</span>,<span class="string">'runBeforeInstanceMethod'</span>,<span class="string">'runAfterInstanceMethod'</span>,<span class="string">'runAfterClassMethod'</span>,<span class="string">'runInsteadClassMethod'</span>,<span class="string">'runInsteadInstanceMethod'</span>,<span class="string">'changePrames'</span>,<span class="string">'changeReturnValue'</span>);</span><br><span class="line">         <span class="keyword">var</span> + = runInstanceMethod(dataSource,<span class="string">'mutableCopy'</span>);</span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>;i &lt; dataSource.length;i ++) &#123;</span><br><span class="line">          <span class="keyword">var</span> budle = runMethod(<span class="string">'NSBundle'</span>,<span class="string">'mainBundle'</span>);</span><br><span class="line">          <span class="keyword">var</span> jsPath = runInstanceMethod(budle,<span class="string">'pathForResource:ofType:'</span>,<span class="keyword">new</span> <span class="built_in">Array</span>(dataSource[i],<span class="string">'js'</span>));</span><br><span class="line">          <span class="keyword">var</span> jsString = runMethod(<span class="string">'NSString'</span>,<span class="string">'stringWithContentsOfFile:encoding:error:'</span>,<span class="keyword">new</span> <span class="built_in">Array</span>(jsPath,<span class="string">'4'</span>));</span><br><span class="line">          runMethod(<span class="string">'LYFix'</span>,<span class="string">'evalString:'</span>,jsString);</span><br><span class="line">          runLog(jsString);</span><br><span class="line">          &#125;</span><br><span class="line">     datas.push(<span class="string">'runClassMethod'</span>,<span class="string">'runInstanceMethod'</span>,<span class="string">'runWithInstanceMethod'</span>,<span class="string">'runWithParams'</span>);</span><br><span class="line">          runInstanceMethod(self,<span class="string">'setDataSource:'</span>,<span class="keyword">new</span> <span class="built_in">Array</span>(datas));</span><br><span class="line">          <span class="keyword">var</span> selfDataSource = runInstanceMethod(self,<span class="string">'dataSource'</span>);</span><br><span class="line">          runLog(datas);</span><br><span class="line">          runLog(selfDataSource);</span><br><span class="line">          <span class="keyword">var</span> tableView = runMethod(<span class="string">'UITableView'</span>,<span class="string">'alloc'</span>);</span><br><span class="line">          <span class="keyword">var</span> bounds = runInstanceMethod(view,<span class="string">'bounds'</span>);</span><br><span class="line">        </span><br><span class="line">          runInstanceMethod(tableView,<span class="string">'initWithFrame:style:'</span>,<span class="keyword">new</span> <span class="built_in">Array</span>(bounds,<span class="string">'0'</span>));</span><br><span class="line">          runInstanceMethod(tableView,<span class="string">'setDataSource:'</span>,self);</span><br><span class="line">          runInstanceMethod(tableView,<span class="string">'setDelegate:'</span>,self);</span><br><span class="line">          runInstanceMethod(tableView,<span class="string">'setFrame:'</span>,bounds);</span><br><span class="line">          runInstanceMethod(view,<span class="string">'addSubview:'</span>,tableView);</span><br><span class="line">          runInstanceMethod(tableView,<span class="string">'reloadData'</span>);</span><br><span class="line"></span><br><span class="line">          &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">fixMethod(<span class="string">'ViewController'</span>,<span class="string">'tableView:didSelectRowAtIndexPath:'</span>,<span class="number">0</span>,<span class="function"><span class="keyword">function</span>(<span class="params">instance,invocation,arg</span>)</span>&#123;</span><br><span class="line">          <span class="comment">//          runError(self, 'calssMethodCrash');</span></span><br><span class="line">          <span class="keyword">var</span> co = <span class="keyword">new</span> <span class="built_in">Array</span>(<span class="built_in">Math</span>.random(),<span class="built_in">Math</span>.random(),<span class="built_in">Math</span>.random(),<span class="built_in">Math</span>.random());</span><br><span class="line">          <span class="keyword">var</span> color = runMethod(<span class="string">'UIColor'</span>,<span class="string">'colorWithRed:green:blue:alpha:'</span>,co);</span><br><span class="line">          <span class="keyword">var</span> view = runInstanceMethod(instance,<span class="string">'view'</span>);</span><br><span class="line"><span class="comment">//                    runError(view, 'viewaaa');</span></span><br><span class="line">          <span class="keyword">var</span> label = runMethod(<span class="string">'UILabel'</span>,<span class="string">'new'</span>);</span><br><span class="line"><span class="comment">//          var fra = runInstanceMethod(view,'frame');</span></span><br><span class="line">          runInstanceMethod(label,<span class="string">'setFrame:'</span>,<span class="keyword">new</span> <span class="built_in">Array</span>(<span class="string">'&#123;&#123;100, 100&#125;, &#123;100, 100&#125;&#125;'</span>));</span><br><span class="line"><span class="comment">//          runInstanceMethod(label,'setFrame:',fra);</span></span><br><span class="line">          runInstanceMethod(label,<span class="string">'setText:'</span>,<span class="string">'test'</span>);</span><br><span class="line">          runInstanceMethod(view,<span class="string">'addSubview:'</span>,label);</span><br><span class="line">          runInstanceMethod(label,<span class="string">'setBackgroundColor:'</span>,<span class="keyword">new</span> <span class="built_in">Array</span>(color));</span><br><span class="line">          </span><br><span class="line">          </span><br><span class="line">          runInstanceMethod(view,<span class="string">'setBackgroundColor:'</span>,<span class="keyword">new</span> <span class="built_in">Array</span>(color));</span><br><span class="line">          &#125;);</span><br></pre></td></tr></table></figure>
<p>hook了首页<strong>viewDidLoad</strong>方法和<strong>tableView</strong>的点击回调函数，其中<strong>viewDidLoad</strong>方法的策略是afer，即执行完原来的方法再执行热修复提供的方法，后者的策略则是instead，即完全替换掉Native的方法。</p>
<p>###加载js文件<br>一般是通过补丁下发服务器下载js文件，然后加载。下发策略和校验策略估计会涉及到公司机密，这里不做分享，但总体思路就是以版本号为文件路径，每次升级版本将上一版本的文件清空，下载加密校验规则可以以文件的md5值加上约定的字符串再做一次md5，符合校验的js文件才能被加载，以防止下载到假的js文件导致APP被攻击。</p>
<hr>
<p>##对Block的支持<br>通过对NSInvocation的扩展类的分析可以发现setArguments方法并不支持Block，js对oc的方法天然支持，oc的方法通过JSContext传递到js的时候自动会转换成js的function，但是js的function传递到oc的时候，就成了<code>JSValue</code>类型，我不知道怎么通过<code>JSValue</code>生成Block。<a href="https://github.com/bang590/JSPatch" target="_blank" rel="noopener">JSPatch</a>的作者<a href="http://blog.cnbang.net/about/" target="_blank" rel="noopener">bang</a>提供了一套方案：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> genCallbackBlock(JSValue *jsVal)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">void</span> (^block)(<span class="keyword">void</span>) = ^(<span class="keyword">void</span>)&#123;&#125;;</span><br><span class="line">    uint8_t *p = (uint8_t *)((__bridge <span class="keyword">void</span> *)block);</span><br><span class="line">    p += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) + <span class="keyword">sizeof</span>(int32_t) *<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">void</span>(**invoke)(<span class="keyword">void</span>) = (<span class="keyword">void</span> (**)(<span class="keyword">void</span>))p;</span><br><span class="line">    </span><br><span class="line">    p += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) + <span class="keyword">sizeof</span>(uintptr_t) * <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> **signature = (<span class="keyword">const</span> <span class="keyword">char</span> **)p;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSMutableDictionary</span> *typeSignatureDict;</span><br><span class="line">    <span class="keyword">if</span> (!typeSignatureDict) &#123;</span><br><span class="line">        typeSignatureDict  = [<span class="built_in">NSMutableDictionary</span> new];</span><br><span class="line">        <span class="meta">#define JP_DEFINE_TYPE_SIGNATURE(_type) \</span></span><br><span class="line">        [typeSignatureDict setObject:@[[<span class="built_in">NSString</span> stringWithUTF8String:<span class="keyword">@encode</span>(_type)], @(<span class="keyword">sizeof</span>(_type))] forKey:@<span class="meta">#_type];\</span></span><br><span class="line"></span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">id</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="built_in">BOOL</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">int</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">void</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">char</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">short</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">unsigned</span> <span class="keyword">short</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">unsigned</span> <span class="keyword">int</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">long</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">unsigned</span> <span class="keyword">long</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">long</span> <span class="keyword">long</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">float</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">double</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">bool</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(size_t);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="built_in">CGFloat</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="built_in">CGSize</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="built_in">CGRect</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="built_in">CGPoint</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="built_in">CGVector</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="built_in">NSRange</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="built_in">NSInteger</span>);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(Class);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(SEL);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">void</span>*);</span><br><span class="line">        JP_DEFINE_TYPE_SIGNATURE(<span class="keyword">void</span> *);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *types = [jsVal[<span class="string">@"args"</span>] toString];</span><br><span class="line">    <span class="built_in">NSArray</span> *lt = [types componentsSeparatedByString:<span class="string">@","</span>];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSString</span> *funcSignature = <span class="string">@"@?0"</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSInteger</span> size = <span class="keyword">sizeof</span>(<span class="keyword">void</span> *);</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSInteger</span> i = <span class="number">1</span>; i &lt; lt.count;) &#123;</span><br><span class="line">        <span class="built_in">NSString</span> *t = trim(lt[i]);</span><br><span class="line">        <span class="built_in">NSString</span> *tpe = typeSignatureDict[typeSignatureDict[t] ? t : <span class="string">@"id"</span>][<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">            funcSignature  =[[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@%@"</span>,tpe, [@(size) stringValue]] stringByAppendingString:funcSignature];</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        funcSignature = [funcSignature stringByAppendingString:[<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"%@%@"</span>, tpe, [@(size) stringValue]]];</span><br><span class="line">        size += [typeSignatureDict[typeSignatureDict[t] ? t : <span class="string">@"id"</span>][<span class="number">1</span>] integerValue];</span><br><span class="line">        </span><br><span class="line">        i = (i != lt.count - <span class="number">1</span>) ? i + <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    IMP msgForwardIMP = _objc_msgForward;</span><br><span class="line"><span class="meta">#if !defined(__arm64__)</span></span><br><span class="line">    <span class="keyword">if</span> ([funcSignature UTF8String][<span class="number">0</span>] == <span class="string">'&#123;'</span>) &#123;</span><br><span class="line">        <span class="comment">//In some cases that returns struct, we should use the '_stret' API:</span></span><br><span class="line">        <span class="comment">//http://sealiesoftware.com/blog/archive/2008/10/30/objc_explain_objc_msgSend_stret.html</span></span><br><span class="line">        <span class="comment">//NSMethodSignature knows the detail but has no API to return, we can only get the info from debugDescription.</span></span><br><span class="line">        <span class="built_in">NSMethodSignature</span> *methodSignature = [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:[funcSignature UTF8String]];</span><br><span class="line">        <span class="keyword">if</span> ([methodSignature.debugDescription rangeOfString:<span class="string">@"is special struct return? YES"</span>].location != <span class="built_in">NSNotFound</span>) &#123;</span><br><span class="line">            msgForwardIMP = (IMP)_objc_msgForward_stret;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    *invoke = (<span class="keyword">void</span> *)msgForwardIMP;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *fs = [funcSignature UTF8String];</span><br><span class="line">    <span class="keyword">char</span> *s = malloc(strlen(fs));</span><br><span class="line">    strcpy(s, fs);</span><br><span class="line">    *signature = s;</span><br><span class="line">    </span><br><span class="line">    objc_setAssociatedObject(block, <span class="string">"_JSValue"</span>, jsVal, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        Class cls = <span class="built_in">NSClassFromString</span>(<span class="string">@"NSBlock"</span>);</span><br><span class="line"><span class="meta">#define JP_HOOK_METHOD(selector, func) &#123;Method method = class_getInstanceMethod([NSObject class], selector); \</span></span><br><span class="line"><span class="built_in">BOOL</span> success = class_addMethod(cls, selector, (IMP)func, method_getTypeEncoding(method)); \</span><br><span class="line"><span class="keyword">if</span> (!success) &#123; class_replaceMethod(cls, selector, (IMP)func, method_getTypeEncoding(method));&#125;&#125;</span><br><span class="line">        </span><br><span class="line">        JP_HOOK_METHOD(<span class="keyword">@selector</span>(methodSignatureForSelector:), block_methodSignatureForSelector);<span class="comment">//*1</span></span><br><span class="line">        JP_HOOK_METHOD(<span class="keyword">@selector</span>(forwardInvocation:), JPForwardInvocation);</span><br><span class="line">    &#125;);<span class="comment">//*2</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> block;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>*1中的方法<code>block_methodSignatureForSelector</code>实现如下</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSMethodSignature</span> *block_methodSignatureForSelector(<span class="keyword">id</span> <span class="keyword">self</span>, SEL _cmd, SEL aSelector) &#123;</span><br><span class="line">    uint8_t *p = (uint8_t *)((__bridge <span class="keyword">void</span> *)<span class="keyword">self</span>);</span><br><span class="line">    p += <span class="keyword">sizeof</span>(<span class="keyword">void</span> *) * <span class="number">2</span> + <span class="keyword">sizeof</span>(int32_t) *<span class="number">2</span> + <span class="keyword">sizeof</span>(uintptr_t) * <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> **signature = (<span class="keyword">const</span> <span class="keyword">char</span> **)p;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSMethodSignature</span> signatureWithObjCTypes:*signature];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>*2中的方法<code>JPForwardInvocation</code>实现如下：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> JPForwardInvocation(__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> assignSlf, SEL selector, <span class="built_in">NSInvocation</span> *invocation)</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line"><span class="meta">#ifdef DEBUG</span></span><br><span class="line">    _JSLastCallStack = [<span class="built_in">NSThread</span> callStackSymbols];</span><br><span class="line"><span class="meta">#endif</span></span><br><span class="line">    <span class="built_in">BOOL</span> deallocFlag = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">id</span> slf = assignSlf;</span><br><span class="line">    <span class="built_in">BOOL</span> isBlock = [[assignSlf <span class="keyword">class</span>] isSubclassOfClass : <span class="built_in">NSClassFromString</span>(<span class="string">@"NSBlock"</span>)];</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMethodSignature</span> *methodSignature = [invocation methodSignature];</span><br><span class="line">    <span class="built_in">NSInteger</span> numberOfArguments = [methodSignature numberOfArguments];</span><br><span class="line">    <span class="built_in">NSString</span> *selectorName = isBlock ? <span class="string">@""</span> : <span class="built_in">NSStringFromSelector</span>(invocation.selector);</span><br><span class="line">    <span class="built_in">NSString</span> *JPSelectorName = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"_JP%@"</span>, selectorName];</span><br><span class="line">    JSValue *jsFunc = isBlock ? objc_getAssociatedObject(assignSlf, <span class="string">"_JSValue"</span>)[<span class="string">@"cb"</span>] : getJSFunctionInObjectHierachy(slf, JPSelectorName);</span><br><span class="line">    <span class="keyword">if</span> (!jsFunc) &#123;</span><br><span class="line">        JPExecuteORIGForwardInvocation(slf, selector, invocation);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSMutableArray</span> *argList = [[<span class="built_in">NSMutableArray</span> alloc] init];</span><br><span class="line">    <span class="keyword">if</span> (!isBlock) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([slf <span class="keyword">class</span>] == slf) &#123;</span><br><span class="line">            [argList addObject:[JSValue valueWithObject:@&#123;<span class="string">@"__clsName"</span>: <span class="built_in">NSStringFromClass</span>([slf <span class="keyword">class</span>])&#125; inContext:_context]];</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([selectorName isEqualToString:<span class="string">@"dealloc"</span>]) &#123;</span><br><span class="line">            [argList addObject:[JPBoxing boxAssignObj:slf]];</span><br><span class="line">            deallocFlag = <span class="literal">YES</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            [argList addObject:[JPBoxing boxWeakObj:slf]];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">NSUInteger</span> i = isBlock ? <span class="number">1</span> : <span class="number">2</span>; i &lt; numberOfArguments; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> <span class="keyword">char</span> *argumentType = [methodSignature getArgumentTypeAtIndex:i];</span><br><span class="line">        <span class="keyword">switch</span>(argumentType[<span class="number">0</span>] == <span class="string">'r'</span> ? argumentType[<span class="number">1</span>] : argumentType[<span class="number">0</span>]) &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="meta">#define JP_FWD_ARG_CASE(_typeChar, _type) \</span></span><br><span class="line">            <span class="keyword">case</span> _typeChar: &#123;   \</span><br><span class="line">                _type arg;  \</span><br><span class="line">                [invocation getArgument:&amp;arg atIndex:i];    \</span><br><span class="line">                [argList addObject:@(arg)]; \</span><br><span class="line">                <span class="keyword">break</span>;  \</span><br><span class="line">            &#125;</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'c'</span>, <span class="keyword">char</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'C'</span>, <span class="keyword">unsigned</span> <span class="keyword">char</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'s'</span>, <span class="keyword">short</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'S'</span>, <span class="keyword">unsigned</span> <span class="keyword">short</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'i'</span>, <span class="keyword">int</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'I'</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'l'</span>, <span class="keyword">long</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'L'</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'q'</span>, <span class="keyword">long</span> <span class="keyword">long</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'Q'</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'f'</span>, <span class="keyword">float</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'d'</span>, <span class="keyword">double</span>)</span><br><span class="line">            JP_FWD_ARG_CASE(<span class="string">'B'</span>, <span class="built_in">BOOL</span>)</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'@'</span>: &#123;</span><br><span class="line">                __<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span> arg;</span><br><span class="line">                [invocation getArgument:&amp;arg atIndex:i];</span><br><span class="line">                <span class="keyword">if</span> ([arg isKindOfClass:<span class="built_in">NSClassFromString</span>(<span class="string">@"NSBlock"</span>)]) &#123;</span><br><span class="line">                    [argList addObject:(arg ? [arg <span class="keyword">copy</span>]: _nilObj)];</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    [argList addObject:(arg ? arg: _nilObj)];</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'&#123;'</span>: &#123;</span><br><span class="line">                <span class="built_in">NSString</span> *typeString = extractStructName([<span class="built_in">NSString</span> stringWithUTF8String:argumentType]);</span><br><span class="line">                <span class="meta">#define JP_FWD_ARG_STRUCT(_type, _transFunc) \</span></span><br><span class="line">                <span class="keyword">if</span> ([typeString rangeOfString:@<span class="meta">#_type].location != NSNotFound) &#123;    \</span></span><br><span class="line">                    _type arg; \</span><br><span class="line">                    [invocation getArgument:&amp;arg atIndex:i];    \</span><br><span class="line">                    [argList addObject:[JSValue _transFunc:arg inContext:_context]];  \</span><br><span class="line">                    <span class="keyword">break</span>; \</span><br><span class="line">                &#125;</span><br><span class="line">                JP_FWD_ARG_STRUCT(<span class="built_in">CGRect</span>, valueWithRect)</span><br><span class="line">                JP_FWD_ARG_STRUCT(<span class="built_in">CGPoint</span>, valueWithPoint)</span><br><span class="line">                JP_FWD_ARG_STRUCT(<span class="built_in">CGSize</span>, valueWithSize)</span><br><span class="line">                JP_FWD_ARG_STRUCT(<span class="built_in">NSRange</span>, valueWithRange)</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">@synchronized</span> (_context) &#123;</span><br><span class="line">                    <span class="built_in">NSDictionary</span> *structDefine = _registeredStruct[typeString];</span><br><span class="line">                    <span class="keyword">if</span> (structDefine) &#123;</span><br><span class="line">                        size_t size = sizeOfStructTypes(structDefine[<span class="string">@"types"</span>]);</span><br><span class="line">                        <span class="keyword">if</span> (size) &#123;</span><br><span class="line">                            <span class="keyword">void</span> *ret = malloc(size);</span><br><span class="line">                            [invocation getArgument:ret atIndex:i];</span><br><span class="line">                            <span class="built_in">NSDictionary</span> *dict = getDictOfStruct(ret, structDefine);</span><br><span class="line">                            [argList addObject:[JSValue valueWithObject:dict inContext:_context]];</span><br><span class="line">                            free(ret);</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">':'</span>: &#123;</span><br><span class="line">                SEL selector;</span><br><span class="line">                [invocation getArgument:&amp;selector atIndex:i];</span><br><span class="line">                <span class="built_in">NSString</span> *selectorName = <span class="built_in">NSStringFromSelector</span>(selector);</span><br><span class="line">                [argList addObject:(selectorName ? selectorName: _nilObj)];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'^'</span>:</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'*'</span>: &#123;</span><br><span class="line">                <span class="keyword">void</span> *arg;</span><br><span class="line">                [invocation getArgument:&amp;arg atIndex:i];</span><br><span class="line">                [argList addObject:[JPBoxing boxPointer:arg]];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">'#'</span>: &#123;</span><br><span class="line">                Class arg;</span><br><span class="line">                [invocation getArgument:&amp;arg atIndex:i];</span><br><span class="line">                [argList addObject:[JPBoxing boxClass:arg]];</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">                <span class="built_in">NSLog</span>(<span class="string">@"error type %s"</span>, argumentType);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_currInvokeSuperClsName[selectorName]) &#123;</span><br><span class="line">        Class cls = <span class="built_in">NSClassFromString</span>(_currInvokeSuperClsName[selectorName]);</span><br><span class="line">        <span class="built_in">NSString</span> *tmpSelectorName = [[selectorName stringByReplacingOccurrencesOfString:<span class="string">@"_JPSUPER_"</span> withString:<span class="string">@"_JP"</span>] stringByReplacingOccurrencesOfString:<span class="string">@"SUPER_"</span> withString:<span class="string">@"_JP"</span>];</span><br><span class="line">        <span class="keyword">if</span> (!_JSOverideMethods[cls][tmpSelectorName]) &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *ORIGSelectorName = [selectorName stringByReplacingOccurrencesOfString:<span class="string">@"SUPER_"</span> withString:<span class="string">@"ORIG"</span>];</span><br><span class="line">            [argList removeObjectAtIndex:<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">id</span> retObj = callSelector(_currInvokeSuperClsName[selectorName], ORIGSelectorName, [JSValue valueWithObject:argList inContext:_context], [JSValue valueWithObject:@&#123;<span class="string">@"__obj"</span>: slf, <span class="string">@"__realClsName"</span>: <span class="string">@""</span>&#125; inContext:_context], <span class="literal">NO</span>);</span><br><span class="line">            <span class="keyword">id</span> __autoreleasing ret = formatJSToOC([JSValue valueWithObject:retObj inContext:_context]);</span><br><span class="line">            [invocation setReturnValue:&amp;ret];</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSArray</span> *params = _formatOCToJSList(argList);</span><br><span class="line">    <span class="keyword">char</span> returnType[<span class="number">255</span>];</span><br><span class="line">    strcpy(returnType, [methodSignature methodReturnType]);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Restore the return type</span></span><br><span class="line">    <span class="keyword">if</span> (strcmp(returnType, <span class="keyword">@encode</span>(JPDouble)) == <span class="number">0</span>) &#123;</span><br><span class="line">        strcpy(returnType, <span class="keyword">@encode</span>(<span class="keyword">double</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (strcmp(returnType, <span class="keyword">@encode</span>(JPFloat)) == <span class="number">0</span>) &#123;</span><br><span class="line">        strcpy(returnType, <span class="keyword">@encode</span>(<span class="keyword">float</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (returnType[<span class="number">0</span>] == <span class="string">'r'</span> ? returnType[<span class="number">1</span>] : returnType[<span class="number">0</span>]) &#123;</span><br><span class="line">        <span class="meta">#define JP_FWD_RET_CALL_JS \</span></span><br><span class="line">            JSValue *jsval; \</span><br><span class="line">            [_JSMethodForwardCallLock lock];   \</span><br><span class="line">            jsval = [jsFunc callWithArguments:params]; \</span><br><span class="line">            [_JSMethodForwardCallLock unlock]; \</span><br><span class="line">            <span class="keyword">while</span> (![jsval isNull] &amp;&amp; ![jsval isUndefined] &amp;&amp; [jsval hasProperty:<span class="string">@"__isPerformInOC"</span>]) &#123; \</span><br><span class="line">                <span class="built_in">NSArray</span> *args = <span class="literal">nil</span>;  \</span><br><span class="line">                JSValue *cb = jsval[<span class="string">@"cb"</span>]; \</span><br><span class="line">                <span class="keyword">if</span> ([jsval hasProperty:<span class="string">@"sel"</span>]) &#123;   \</span><br><span class="line">                    <span class="keyword">id</span> callRet = callSelector(![jsval[<span class="string">@"clsName"</span>] isUndefined] ? [jsval[<span class="string">@"clsName"</span>] toString] : <span class="literal">nil</span>, [jsval[<span class="string">@"sel"</span>] toString], jsval[<span class="string">@"args"</span>], ![jsval[<span class="string">@"obj"</span>] isUndefined] ? jsval[<span class="string">@"obj"</span>] : <span class="literal">nil</span>, <span class="literal">NO</span>);  \</span><br><span class="line">                    args = @[[_context[<span class="string">@"_formatOCToJS"</span>] callWithArguments:callRet ? @[callRet] : _formatOCToJSList(@[_nilObj])]];  \</span><br><span class="line">                &#125;   \</span><br><span class="line">                [_JSMethodForwardCallLock lock];    \</span><br><span class="line">                jsval = [cb callWithArguments:args];  \</span><br><span class="line">                [_JSMethodForwardCallLock unlock];  \</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#define JP_FWD_RET_CASE_RET(_typeChar, _type, _retCode)   \</span></span><br><span class="line">            <span class="keyword">case</span> _typeChar : &#123; \</span><br><span class="line">                JP_FWD_RET_CALL_JS \</span><br><span class="line">                _retCode \</span><br><span class="line">                [invocation setReturnValue:&amp;ret];\</span><br><span class="line">                <span class="keyword">break</span>;  \</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#define JP_FWD_RET_CASE(_typeChar, _type, _typeSelector)   \</span></span><br><span class="line">            JP_FWD_RET_CASE_RET(_typeChar, _type, _type ret = [[jsval toObject] _typeSelector];)   \</span><br><span class="line"></span><br><span class="line">        <span class="meta">#define JP_FWD_RET_CODE_ID \</span></span><br><span class="line">            <span class="keyword">id</span> __autoreleasing ret = formatJSToOC(jsval); \</span><br><span class="line">            <span class="keyword">if</span> (ret == _nilObj ||   \</span><br><span class="line">                ([ret isKindOfClass:[<span class="built_in">NSNumber</span> <span class="keyword">class</span>]] &amp;&amp; strcmp([ret objCType], <span class="string">"c"</span>) == <span class="number">0</span> &amp;&amp; ![ret boolValue])) ret = <span class="literal">nil</span>;  \</span><br><span class="line"></span><br><span class="line">        <span class="meta">#define JP_FWD_RET_CODE_POINTER    \</span></span><br><span class="line">            <span class="keyword">void</span> *ret; \</span><br><span class="line">            <span class="keyword">id</span> obj = formatJSToOC(jsval); \</span><br><span class="line">            <span class="keyword">if</span> ([obj isKindOfClass:[JPBoxing <span class="keyword">class</span>]]) &#123; \</span><br><span class="line">                ret = [((JPBoxing *)obj) unboxPointer]; \</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">#define JP_FWD_RET_CODE_CLASS    \</span></span><br><span class="line">            Class ret;   \</span><br><span class="line">            ret = formatJSToOC(jsval);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="meta">#define JP_FWD_RET_CODE_SEL    \</span></span><br><span class="line">            SEL ret;   \</span><br><span class="line">            <span class="keyword">id</span> obj = formatJSToOC(jsval); \</span><br><span class="line">            <span class="keyword">if</span> ([obj isKindOfClass:[<span class="built_in">NSString</span> <span class="keyword">class</span>]]) &#123; \</span><br><span class="line">                ret = <span class="built_in">NSSelectorFromString</span>(obj); \</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        JP_FWD_RET_CASE_RET(<span class="string">'@'</span>, <span class="keyword">id</span>, JP_FWD_RET_CODE_ID)</span><br><span class="line">        JP_FWD_RET_CASE_RET(<span class="string">'^'</span>, <span class="keyword">void</span>*, JP_FWD_RET_CODE_POINTER)</span><br><span class="line">        JP_FWD_RET_CASE_RET(<span class="string">'*'</span>, <span class="keyword">void</span>*, JP_FWD_RET_CODE_POINTER)</span><br><span class="line">        JP_FWD_RET_CASE_RET(<span class="string">'#'</span>, Class, JP_FWD_RET_CODE_CLASS)</span><br><span class="line">        JP_FWD_RET_CASE_RET(<span class="string">':'</span>, SEL, JP_FWD_RET_CODE_SEL)</span><br><span class="line"></span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'c'</span>, <span class="keyword">char</span>, charValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'C'</span>, <span class="keyword">unsigned</span> <span class="keyword">char</span>, unsignedCharValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'s'</span>, <span class="keyword">short</span>, shortValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'S'</span>, <span class="keyword">unsigned</span> <span class="keyword">short</span>, unsignedShortValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'i'</span>, <span class="keyword">int</span>, intValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'I'</span>, <span class="keyword">unsigned</span> <span class="keyword">int</span>, unsignedIntValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'l'</span>, <span class="keyword">long</span>, longValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'L'</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span>, unsignedLongValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'q'</span>, <span class="keyword">long</span> <span class="keyword">long</span>, longLongValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'Q'</span>, <span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>, unsignedLongLongValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'f'</span>, <span class="keyword">float</span>, floatValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'d'</span>, <span class="keyword">double</span>, doubleValue)</span><br><span class="line">        JP_FWD_RET_CASE(<span class="string">'B'</span>, <span class="built_in">BOOL</span>, boolValue)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">case</span> <span class="string">'v'</span>: &#123;</span><br><span class="line">            JP_FWD_RET_CALL_JS</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">case</span> <span class="string">'&#123;'</span>: &#123;</span><br><span class="line">            <span class="built_in">NSString</span> *typeString = extractStructName([<span class="built_in">NSString</span> stringWithUTF8String:returnType]);</span><br><span class="line">            <span class="meta">#define JP_FWD_RET_STRUCT(_type, _funcSuffix) \</span></span><br><span class="line">            <span class="keyword">if</span> ([typeString rangeOfString:@<span class="meta">#_type].location != NSNotFound) &#123;    \</span></span><br><span class="line">                JP_FWD_RET_CALL_JS \</span><br><span class="line">                _type ret = [jsval _funcSuffix]; \</span><br><span class="line">                [invocation setReturnValue:&amp;ret];\</span><br><span class="line">                <span class="keyword">break</span>;  \</span><br><span class="line">            &#125;</span><br><span class="line">            JP_FWD_RET_STRUCT(<span class="built_in">CGRect</span>, toRect)</span><br><span class="line">            JP_FWD_RET_STRUCT(<span class="built_in">CGPoint</span>, toPoint)</span><br><span class="line">            JP_FWD_RET_STRUCT(<span class="built_in">CGSize</span>, toSize)</span><br><span class="line">            JP_FWD_RET_STRUCT(<span class="built_in">NSRange</span>, toRange)</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">@synchronized</span> (_context) &#123;</span><br><span class="line">                <span class="built_in">NSDictionary</span> *structDefine = _registeredStruct[typeString];</span><br><span class="line">                <span class="keyword">if</span> (structDefine) &#123;</span><br><span class="line">                    size_t size = sizeOfStructTypes(structDefine[<span class="string">@"types"</span>]);</span><br><span class="line">                    JP_FWD_RET_CALL_JS</span><br><span class="line">                    <span class="keyword">void</span> *ret = malloc(size);</span><br><span class="line">                    <span class="built_in">NSDictionary</span> *dict = formatJSToOC(jsval);</span><br><span class="line">                    getStructDataWithDict(ret, dict, structDefine);</span><br><span class="line">                    [invocation setReturnValue:ret];</span><br><span class="line">                    free(ret);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (_pointersToRelease) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">NSValue</span> *val <span class="keyword">in</span> _pointersToRelease) &#123;</span><br><span class="line">            <span class="keyword">void</span> *pointer = <span class="literal">NULL</span>;</span><br><span class="line">            [val getValue:&amp;pointer];</span><br><span class="line">            <span class="built_in">CFRelease</span>(pointer);</span><br><span class="line">        &#125;</span><br><span class="line">        _pointersToRelease = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (deallocFlag) &#123;</span><br><span class="line">        slf = <span class="literal">nil</span>;</span><br><span class="line">        Class instClass = object_getClass(assignSlf);</span><br><span class="line">        Method deallocMethod = class_getInstanceMethod(instClass, <span class="built_in">NSSelectorFromString</span>(<span class="string">@"ORIGdealloc"</span>));</span><br><span class="line">        <span class="keyword">void</span> (*originalDealloc)(__<span class="keyword">unsafe_unretained</span> <span class="keyword">id</span>, SEL) = (__typeof__(originalDealloc))method_getImplementation(deallocMethod);</span><br><span class="line">        originalDealloc(assignSlf, <span class="built_in">NSSelectorFromString</span>(<span class="string">@"dealloc"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，实现起来相当复杂，但是JSPatch还提供了一套更清晰更完善的实现方案，我用了<code>JPBlockWrapper</code>提供的方案。</p>
<p>###引入Block相关的文件和静态库</p>
<blockquote>
<ul>
<li>JPLibffi以及libffi静态库，libffi的作用是动态的定义和调用c函数，<a href="https://blog.csdn.net/jaimecool/article/details/76332930" target="_blank" rel="noopener">这里</a>有初步介绍，熟练使用这个库可以实现多种语言之间的互相调用。</li>
<li><code>JPBlockWrapper</code>头文件和.m文件。</li>
<li><code>JPEngine</code>头文件和.m文件。引用它仅仅是因为<code>JPBlockWrapper</code>用到了<code>JPExtension</code>提供的几个静态类方法，并没有实际用到<code>JPEngine</code>类。</li>
</ul>
</blockquote>
<p>###注册一个用于生成<code>JPBlockWrapper</code>对象的协议<br>在热修复类的fix方法中添加以下代码：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">context[<span class="string">@"__genBlock"</span>] = ^<span class="keyword">id</span>(<span class="built_in">NSString</span> *typeString, JSValue *cb) &#123;</span><br><span class="line">    JPBlockWrapper *blockWrapper = [[JPBlockWrapper alloc] initWithTypeString:typeString callbackFunction:cb];</span><br><span class="line">    <span class="keyword">return</span> blockWrapper;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>###将<code>JPBlockWrapper</code>生成的block作为<code>NSInvocation</code>的参数。<br><code>NSInvocation+YHAddtion.m</code>文件设置argument时，如果Type是对象类型的，改成：</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="string">'@'</span>: <span class="comment">// id</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> arg = obj;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ([arg isKindOfClass:JPBlockWrapper.class]) &#123;</span><br><span class="line">        __autoreleasing <span class="keyword">id</span> cb = [arg blockPtr];</span><br><span class="line">        [<span class="keyword">self</span> setArgument:&amp;cb atIndex:index];</span><br><span class="line">        Block_release((__bridge <span class="keyword">void</span> *)cb);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> setArgument:&amp;arg atIndex:index];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125; <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>
<p>###用法<br>至此，基于Aspect的热修复方案可以支持Block了，用法与JSPatch对于block的用法差不多，JSPatch给出的demo是</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">defineClass(<span class="string">"newBlockTest"</span>, &#123;</span><br><span class="line">testJSBlockToOCCall: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    self.performBlock(block(<span class="string">"CGFloat, int, CGPoint, double, CGFloat, NSNumber*, NSString*, NSInteger"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">arg1, arg2, arg3, arg4, arg5, arg6, arg7</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> arg1 + arg2.x + arg2.y + arg3 + arg4 + arg5 + arg6.doubleValue() + arg7;</span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br><span class="line">&#125;, &#123;&#125;);</span><br></pre></td></tr></table></figure>
<p>只不过，JSPatch在外面多包了一层<code>JPBlock</code>，（对于<code>JPBlock</code>的源码解析值得再开一篇帖子,可以看<a href="https://kennaki.github.io/2018/09/13/%E5%9F%BA%E4%BA%8EAspect%E7%9A%84%E7%83%AD%E4%BF%AE%E5%A4%8D%E5%8F%8A%E5%85%B6%E5%AF%B9Block%E7%9A%84%E6%94%AF%E6%8C%81/" target="_blank" rel="noopener">这里</a>）这里的用法是把上面的<code>block(arg_list_string, js_function)</code>改为<code>__genBlock(arg_list_string, js_function)</code>。</p>
<hr>
<h2 id="What-are-you-looking-for"><a href="#What-are-you-looking-for" class="headerlink" title="What are you looking for! "></a>What are you looking for! <img src="../images/avatar.png" alt="&#39;avatar&#39;"></h2>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/13/JSPatch中JPBlock的源码分析/" rel="prev" title="JSPatch中JPBlock的源码分析">
                JSPatch中JPBlock的源码分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Kennaki Kai</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Kennaki" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://plus.google.com/u/0/100833649995696706926" target="_blank" title="Google">
                      
                        <i class="fa fa-fw fa-google"></i>Google</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.facebook.com/gaijianqiu" target="_blank" title="FB Page">
                      
                        <i class="fa fa-fw fa-facebook"></i>FB Page</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Aspect-的实现"><span class="nav-number">1.</span> <span class="nav-text">Aspect 的实现</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#What-are-you-looking-for"><span class="nav-number">2.</span> <span class="nav-text">What are you looking for! </span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kennaki Kai</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  




  
  









  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three.min.js"></script>
  

  
  
    <script type="text/javascript" src="/lib/three/three-waves.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
